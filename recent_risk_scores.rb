output = File.open( "output.csv","w" )
output.puts "Server Type,Assets Discovered, Total Risk,Avg. Risk per Asset,color,Last Avg. Risk per Asset,% chg."

@nsc.list_sites.each do | site |
	currMonth = Time.now.mon
	lastMonth = (Time.now - 1.month).mon
	# 0th element of the array should always be the most recent scan
       	lastCompleteScan = @nsc.completed_scans(site.id).select { |scan| scan.start_time.mon == currMonth  && scan.status == :completed }[0]
	secondToLastCompleteScan = @nsc.completed_scans(site.id).select { |scan| scan.start_time.mon == lastMonth && scan.status == :completed }[1]

       	unless lastCompleteScan.nil?
		# only grab sites with the phrase "PURPOSE-" in the name
		if site.name.include? "PURPOSE-" 
			# generate metrics, store in variables
			siteName = site.name
			siteName.slice! "PURPOSE-"
			assetCount = lastCompleteScan.assets
               		riskScore = lastCompleteScan.risk_score
			oldAssetCount = secondToLastCompleteScan.assets
			oldRiskScore = secondToLastCompleteScan.risk_score
			avgRiskPerAsset = riskScore / assetCount
			oldAvgRiskPerAsset = oldRiskScore / oldAssetCount
			riskDiff = oldAvgRiskPerAsset - avgRiskPerAsset
			delta = (riskDiff / oldAvgRiskPerAsset) * -1
			delta = delta.round(2)

			# indicate whether trend is positive or negative since last risk measure
			if delta > 0
				color = "red"
			elsif delta < 0
				color = "green"
			# doing it this way also allows us to leave the color set to 'nil' (default is blue) for values of exactly 0
			end
			
			# pretty print to console
			puts "srvtype " + siteName + "\'s avg. risk score\: " + avgRiskPerAsset.to_s + " (" + delta.to_s + "%) . Last month's avg. risk was " + oldAvgRiskPerAsset.to_s + "."
			# old data spec: srvtype name,avg. risk per asset,color,last avg. risk per asset,% chg.
			# output.puts siteName + "," + avgRiskPerAsset.to_s + "," + color.to_s + "," +  oldAvgRiskPerAsset.to_s + "," + delta.to_s
			# intended data spec: srvtype name,assets discovered,total risk score,avg. risk per asset,color,last avg. risk per asset,% chg.
			output.puts siteName + "," + assetCount.to_s + "," + riskScore.to_s + "," + avgRiskPerAsset.to_s + "," + color.to_s + "," +  oldAvgRiskPerAsset.to_s + "," + delta.to_s
       		end
	else
		# informational msg, don't print to csv because we don't want that junk data
              	puts site.name + " has never been scanned, skipping..."
       	end
end
output.close
