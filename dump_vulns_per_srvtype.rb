class NexposeController < ApplicationController

def initialize(server='127.0.0.1', port=443)
# Called by everything in this controller

        #server='127.0.0.1' ;port=443
        nexpose_username = File.read("lib/nexpose_username.txt").gsub("\n", "")
        nexpose_password = File.read("lib/nexpose_password.txt").gsub("\n", "")

        @nsc = Nexpose::Connection.new(server, nexpose_username, nexpose_password, port)
        @nsc.login

        @base_api_url          = Setting.where(key:"uber_api_url")[0].value
        @uber_url              = Setting.where(key:"uber_url")[0].value
        @lc_production_dns_domain = Setting.where(key:"production_dns_domain")[0].value
        @lc_description        = Setting.where(key:"description")[0].value
        @lc_short_code         = Setting.where(key:"short_code")[0].value

end

def dump_vulns_per_srvtype
	@nsc.list_sites.each do | site |
		if site.name.include? "PURPOSE-"
			siteID = site.id
			siteName = site.name
			siteName.slice! "PURPOSE-"
			output = File.open("app/assets/data/srvtype/" + siteName + ".csv","w" )
			puts "site ID: " + siteID.to_s + ", site name: " + siteName
		
			@nsc.list_assets(siteID).each do | device |
				deviceID = device.id
				deviceAddress = device.address
				puts "device ID: " + deviceID.to_s + ", device address: " + deviceAddress.to_s
			
				@nsc.list_device_vulns(deviceID).each do | vuln |
					severity = vuln.severity
					if severity >= 8
						severity = "Critical"
					elsif severity >= 4
						severity = "Severe"
					elsif severity < 4
						severity = "Moderate"
					end
					output.puts siteName + "," + deviceAddress.to_s + "," + vuln.title + "," + vuln.risk.to_s + "," + severity.to_s
#					puts siteName + "," + deviceAddress.to_s + "," + vuln.title + "," + vuln.risk.to_s + "," + severity.to_s
				end
			end
		output.close
		end
	end
end
