#!/bin/bash

file="$1"
dir=$(dirname "$file")

if [ -z "$file" ]; then
        echo "No input file detected!"
        exit 1
fi

main() {
        severity_split
        category_split
        host_split
}

severity_split() {
        filename="$dir/severity.csv"
        cat /dev/null > "$filename"
        echo "severity,count" >> "$filename"
        for severity in Moderate Severe Critical; do
                count=$(grep $severity "$file" | wc -l)
                echo "$severity,$count" >> "$filename"
        done
}

category_split() {
        filename="$dir/category.csv"
        cat /dev/null > "$filename"
        echo "vuln category,aggregate risk" >> "$filename"
        for category in "Adobe Flash"\
                "Apache HTTPD"\
                "Apache Tomcat"\
                CIFS\
                DNS\
                FTP\
                "ISC BIND"\
                ICMP\
                lighttpd\
                MYSQL\
                NTP\
                OpenSSH\
                OpenSSL\
                "Oracle MySQL"\
                "PHP Vulnerability"\
                PostgreSQL\
                SMB\
                SMTP\
                TLS\
                TLS/SSL\
                Ubuntu\
                VMSA\
                VNC\
                X.509; do
                count=$(./aggregate_vuln_scores "$file" | grep "$category" | awk -F, '{sum += $2} END {print sum}')
                if [ $count ]; then
                        echo "$category-related,$count" >> "$filename"
                fi
        done
}

host_split() {
        filename="$dir/host.csv"
        cat /dev/null > "$filename"
        echo "vuln count,aggregate risk,ip address" >> "$filename"
        for ip in $(egrep -o "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" "$file" | uniq); do
                risk=$(grep $ip "$file" | awk -F, '{sum += $4} END {print sum}')
                count=$(grep $ip "$file" | wc -l)
                echo "$count,$risk,$ip" >> "$filename"
        done
}

main
